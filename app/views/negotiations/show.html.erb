<p><%= link_to 'Voltar', negotiations_path %> - <%= link_to 'Página do produto', product_path(@negotiation.product) %></p>

<% if @negotiation.seller_id == current_collaborator.id or @negotiation.buyer_id == current_collaborator.id %>
  <% if @negotiation.canceled? %>

    <h3>Esta negociação foi cancelada :(</h3>
    <p>O produto era:</p>
    <li><%= @negotiation.product.name %></li>
    <p>Do vendedor:</p>
    <li><%= @negotiation.seller_name %></li>
    <li><%= @negotiation.seller_email %></li>
    <p>Cancelada em <%= l(@negotiation.date_of_end) %></p>

  <% elsif @negotiation.sold? %>

    <h3>Esta negociação foi concluída!</h3>
    <p>Detalhes da negociação:</p>
    <dl>
      <dt><b>Produto:</b></dt>
      <dd><%= @negotiation.product.name %></dd>
      <%#TODO Foto do produto aqui %>
      <%= @negotiation.product.description %><br><br>

      <dt><b>Comprador:</b></dt>
      <dd><%= @negotiation.buyer_name %></dd>
      <dd><%= @negotiation.product.collaborator.sector %></dd>
      <dd><%= @negotiation.buyer_email %></dd><br>

      <dt><b>Vendedor:</b></dt>
      <dd><%= @negotiation.seller_name %></dd>
      <dd><%= @negotiation.collaborator.sector %></dd>
      <dd><%= @negotiation.seller_email %></dd><br>

      <dt><b>Preço final e data da venda:</b></dt>
      <dd><%= number_to_currency(@negotiation.final_price) %></dd>
      <dd><%= l(@negotiation.date_of_end) %></dd><br>
    </dl>
    <h3>Mensagens trocadas entre colaboradores:</h3>
    <% @messages.each do |message| %>
      <%= render message, locals: {message: :message} %>
    <% end %>

  <% else %> <!-- Está "negotiating" ou "waiting" -->

    <% if @negotiation.seller_id == current_collaborator.id and @negotiation.waiting? %>

      <p>Você aceita esta negociação?</p>
      <%= button_to 'Sim', negotiating_negotiation_path(@negotiation) %><br>
      <%= button_to 'Não', canceled_negotiation_path(@negotiation) %>

    <% elsif @negotiation.seller_id == current_collaborator.id and @negotiation.negotiating? %>

      <p>Você pode CONFIRMAR ou CANCELAR esta negociação.</p>
      <%= button_to 'Confirmar', confirm_negotiation_path(@negotiation), method: :get %><br>
      <%= button_to 'Cancelar', canceled_negotiation_path(@negotiation) %>

    <% elsif @negotiation.buyer_id == current_collaborator.id %>

      <p>Você quer CANCELAR a negociação?</p>
      <%= button_to 'Cancelar', canceled_negotiation_path(@negotiation) %>

    <% end %>

    <h2><%= @negotiation.product.name %></h2>
    Vendedor:
    <ul>
      <li><%= @negotiation.seller_name %></li>
      <li><%= @negotiation.seller_email %></li>
    </ul>
    Comprador:
    <ul>
      <li><%= @negotiation.buyer_name %></li>
      <li><%= @negotiation.buyer_email %></li>
    </ul>

    <% if @negotiation.negotiating? %> <!-- Seção das mensagens -->
      <p>--------------------------------------------------</p>
      <h4>Mensagens</h4>
      <p>--------------------------------------------------</p>
      <% @messages.each do |message| %>
        <%= render message, locals: {message: :message} %>
      <% end %>
      <%#OPTIMIZE Podia dar um jeito de usar esse each em uma linha, né %>
      <%#= @messages.each {|message| render message, locals: {message: :message}} %>
      <p>--------------------------------------------------</p>
    <% else %>
      <p>Quando a negociação for aceita, mensagens poderão ser trocadas por aqui.</p>
    <% end %>
    <%= render 'messages/new_message' if @negotiation.negotiating? %>
    
  <% end %>

<% else %> <!-- Você não pode ver porque não está envolvido na negociação -->
  Somente pessoas envolvidas na negociação podem ver detalhes da mesma.
<% end %>
